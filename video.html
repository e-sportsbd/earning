<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</title>

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:Arial;
  background:#f5f5f5;
}
h3{
  margin:0;
  padding:8px;
  text-align:center;
  background:#feca2a;
}
#iframe-container{
  height:100%;
  position:relative;
}
iframe{
  width:100%;
  height:calc(100% - 120px);
  border:none;
}
#controls{
  position:absolute;
  bottom:0;
  width:100%;
  background:rgba(0,0,0,.0);;
  padding:12px;
  text-align:center;
  box-shadow:0 -2px 6px rgba(0,0,0,.0);
}
#timer{
  font-size:22px;
  color:#008000;
  margin-bottom:6px;
}
button{
  padding:12px 26px;
  font-size:18px;
  border:none;
  border-radius:8px;
  background:#0088cc;
  color:#fff;
}
button:disabled{
  background:#999;
}
</style>
</head>

<body>

<div id="iframe-container">
  <h3>‡¶∏‡¶¨ Ads ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç 200 Token ‡¶™‡¶æ‡¶®</h3>

  <iframe id="adFrame"></iframe>

  <div id="controls">
    <div id="timer">15</div>
    <button id="doneBtn" disabled>‚úÖ Done</button>
  </div>
</div>

<script>
/* ================= TELEGRAM ================= */
const tg = window.Telegram?.WebApp;
if(tg) tg.ready();
const userId = tg?.initDataUnsafe?.user?.id;
if(!userId && tg){ tg.close(); }

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
  databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com",
  projectId: "post-c7e41",
  appId: "1:758133068153:web:28ef27e45d8037e0d49fa8"
});
const db = firebase.database();
const userRef = db.ref("users/" + userId);

/* ================= ADS CONFIG ================= */
const ads = [
  "https://t.me/adsgram_ai?start=AD1",
  "https://t.me/adsgram_ai?start=AD2",
  "https://t.me/adsgram_ai?start=AD3"
];

const secondsPerAd = 15;
const rewardPerSession = 200;

/* ================= STATE ================= */
let currentAd = 0;
let timeLeft = secondsPerAd;
let timerInterval;

const adFrame = document.getElementById("adFrame");
const timerEl = document.getElementById("timer");
const doneBtn = document.getElementById("doneBtn");

/* ================= LOAD ADS ================= */
function loadAd(){
  if(currentAd >= ads.length){
    timerEl.innerText = "‚úÖ ‡¶∏‡¶¨ Ads ‡¶∂‡ßá‡¶∑";
    doneBtn.disabled = false;
    return;
  }

  adFrame.src = ads[currentAd];
  timeLeft = secondsPerAd;
  timerEl.innerText = timeLeft;

  timerInterval = setInterval(()=>{
    timeLeft--;
    timerEl.innerText = timeLeft;

    if(timeLeft <= 0){
      clearInterval(timerInterval);
      currentAd++;
      loadAd();
    }
  },1000);
}

loadAd();

/* ================= DONE BUTTON ================= */
doneBtn.onclick = async ()=>{
  const now = new Date();
  const currentHour = now.getHours();

  try{
    const snap = await userRef.get();
    if(!snap.exists()){
      alert("User data missing");
      return;
    }

    const d = snap.val();

    let balance = d.balance || 0;
    let dailyDone = d.dailyDone || 0;
    let hourlyDone = d.hourlyDone || 0;
    let lastHour = d.lastHour ?? currentHour;

    // Hour reset
    if(lastHour !== currentHour){
      hourlyDone = 0;
      lastHour = currentHour;
    }

    await userRef.update({
      balance: balance + rewardPerSession,
      dailyDone: dailyDone + 1,
      hourlyDone: hourlyDone + 1,
      lastHour: lastHour
    });

    if(tg){
      tg.sendData("ads_verified");
    }

    // üëâ Back to homepage
    window.location.href = "index.html";

  }catch(err){
    alert("‚ùå Token add failed");
  }
};

/* ================= ANTI CLOSE ================= */
window.addEventListener("beforeunload", function(e){
  if(doneBtn.disabled){
    e.preventDefault();
    e.returnValue = "Ads ‡¶∂‡ßá‡¶∑ ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá token ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ!";
  }
});
</script>

</body>
</html>