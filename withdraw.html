<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#0b0f1a;color:#fff}
.app{max-width:480px;margin:auto;padding:16px;padding-bottom:90px}

.card{
  background:#12172a;
  border:1px solid #2b335a;
  border-radius:18px;
  padding:16px
}
h2{text-align:center;margin-bottom:10px}

.info{
  background:#181f3a;
  padding:12px;
  border-radius:12px;
  font-size:13px;
  margin-bottom:12px;
  line-height:1.6
}

input,select,button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:14px;
  border:none;
  font-size:15px
}

input,select{
  background:#0f1428;
  color:#fff;
  border:1px solid #2b335a
}

button{
  background:linear-gradient(135deg,#6a5cff,#2ec7ff);
  color:#fff;
  font-size:16px
}

.live{
  background:#0f1428;
  border:1px dashed #2ec7ff;
  border-radius:12px;
  padding:10px;
  margin-top:8px;
  text-align:center;
  font-size:14px
}

/* NAV */
.nav{
  position:fixed;
  bottom:0;left:0;width:100%;
  background:#12172a;
  border-top:1px solid #2b335a;
  display:flex;
  justify-content:space-around;
  padding:12px 0
}
.nav span{opacity:.6;font-size:14px}
.nav .active{opacity:1;color:#6a5cff}
</style>
</head>

<body>

<div class="app">
  <div class="card">
    <h2>üí≥ Withdraw</h2>

    <div class="info" id="rules">Loading withdraw rules...</div>

    <input type="number" id="coins" placeholder="Enter coins">
    <div class="live" id="taka">üí° Enter coins</div>

    <select id="method">
      <option value="">Select Payment Method</option>
    </select>

    <input type="text" id="account" placeholder="Enter account number">

    <button id="submitBtn">üöÄ Submit Withdraw</button>
  </div>

  <button onclick="location.href='withdraw_history.html'">üìú Withdraw History</button>
</div>

<!-- NAV -->
<div class="nav">
  <span onclick="location.href='index.html'">Home</span>
  <span onclick="location.href='tasks.html'">Tasks</span>
  <span onclick="location.href='invite.html'">Invite</span>
  <span class="active">Withdraw</span>
</div>

<script>
/* ===== TELEGRAM ===== */
const tg = Telegram.WebApp;
tg.ready(); tg.expand();

const user = tg.initDataUnsafe?.user;
if(!user){ tg.close(); }

const uid = String(user.id);

/* ===== FIREBASE INIT ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
  databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com",
  projectId: "post-c7e41",
  appId: "1:758133068153:web:28ef27e45d8037e0d49fa8"
});

const db = firebase.database();
const adminRef    = db.ref("adminControl/withdraw");
const userRef     = db.ref("users/" + uid);
const withdrawRef = db.ref("withdraw_requests");

/* ===== STATE ===== */
let CONFIG = {};
let USER   = { balance: 0, totalInvites: 0 };

/* ===== LOAD ADMIN CONFIG ===== */
adminRef.once("value").then(snap=>{
  if(!snap.exists()) return showError("Withdraw system not configured");

  CONFIG = snap.val();

  if(CONFIG.withdrawEnabled === false){
    return showError("Withdraw currently disabled");
  }

  loadUser();
});

/* ===== LOAD USER ===== */
function loadUser(){
  userRef.once("value").then(snap=>{
    if(snap.exists()){
      USER.balance = snap.val().balance || 0;
      USER.totalInvites = snap.val().totalInvites || 0;
    }
    renderUI();
  });
}

/* ===== RENDER UI ===== */
function renderUI(){
  rules.innerHTML = `
    üí∞ Rate: 1 Coin = ‡ß≥${CONFIG.coinRate}<br>
    üîª Minimum: ${CONFIG.minWithdrawCoins} coins<br>
    üî∫ Maximum: ${CONFIG.maxWithdrawCoins} coins<br>
    üë• Required Invites: ${CONFIG.minInvites}<br>
    üíº Your Balance: <b>${USER.balance}</b>
  `;

  method.innerHTML = `<option value="">Select Payment Method</option>`;
  if(CONFIG.bkashEnabled) method.innerHTML += `<option value="Bkash">Bkash</option>`;
  if(CONFIG.nagadEnabled) method.innerHTML += `<option value="Nagad">Nagad</option>`;
}

/* ===== ERROR ===== */
function showError(msg){
  document.body.innerHTML =
    `<h2 style="text-align:center;margin-top:70px;color:#ff6b6b">‚ùå ${msg}</h2>`;
}

/* ===== CALC ===== */
coins.oninput = ()=>{
  const c = Number(coins.value);
  taka.innerHTML = c
    ? `üíµ You will receive ‡ß≥${c * CONFIG.coinRate}`
    : "üí° Enter coins";
};

/* ===== SUBMIT ===== */
submitBtn.onclick = ()=>{
  const c = Number(coins.value);
  const m = method.value;
  const a = account.value.trim();

  if(!c || !m || !a)
    return tg.showAlert("Please fill all fields");

  if(c < CONFIG.minWithdrawCoins || c > CONFIG.maxWithdrawCoins)
    return tg.showAlert("Withdraw amount out of limit");

  if(USER.totalInvites < CONFIG.minInvites)
    return tg.showAlert("Invite requirement not met");

  if(USER.balance < c)
    return tg.showAlert("Insufficient balance");

  submitBtn.disabled = true;

  withdrawRef.push({
    userId: uid,
    coins: c,
    taka: c * CONFIG.coinRate,
    method: m,
    account: a,
    status: "pending",
    time: Date.now()
  });

  userRef.update({
    balance: USER.balance - c
  });

  tg.showAlert("‚úÖ Withdraw request submitted");
  setTimeout(()=>tg.close(),1500);
};
</script>

</body>
</html>